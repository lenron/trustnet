<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Crypto Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>


	<div>
	   <h1>Hex64 Decode/Encode</h1>
	</div>
	<div id='encode64pane'>
		<div style="display: flex; flex-direction: column; border-style: inset;">
			<div style="display: flex;">
				<div style="display: flex; flex-direction: column;">
					<label>Raw:</label>
					<input id="raw_64encode_text" style="width: 400px;"></input>
				</div>
				<div>
					<span style='font-size:40px; margin: 4px;'>&#8680;</span>
				</div>
				<div style="display: flex; flex-direction: column;">
					<label>64 Encoded:</label>
					<input id="encoded64_text" style="width: 400px;"></input>
				</div>
			</div>
			<button id='encode64' onclick="encode64()" style="width: 80px">Encode 64</button>
		</div>
		<br>
		<div style="display: flex; flex-direction: column; border-style: inset;">
			<div style="display: flex;">
				<div style="display: flex; flex-direction: column;">
					<label>64 Encoded:</label>
					<input id="raw_64encoded_text" style="width: 400px;"></input>
				</div>
				<div>
					<span style='font-size:40px; margin: 4px;'>&#8680;</span>
				</div>
				<div style="display: flex; flex-direction: column;">
					<label>64 Decoded:</label>
					<input id="decoded64_text" style="width: 400px;"></input>
				</div>
			</div>
			<button id='decode64' onclick="decode64()" style="width: 100px">Decode 64</button>
		</div>
	</div>


	<div>
	   <h1>Setup AES-256-CBC</h1>
	</div>
	<div id='encrypt_pane' style="display: flex; flex-direction: column; border-style: inset;">
		<div style="display: flex; flex-direction: row;">
			<div style="margin: 5px;"> 
				<div style="display: flex; flex-direction: column;">
					<div style="display: flex; flex-direction: column;">
						<label>Plaintext:</label>
						<input id="enter_plaintext" style="width: 400px;"></input>
					</div>
					<div style="display: flex;">
						<div style="display: flex; flex-direction: column;">
							<label>Initialization Vector (IV):</label>
							<input id="enter_iv" style="width: 400px;"></input>
						</div>
						<div style="display: flex; align-items: flex-end;">
							<button id='gen_iv' onclick="genIv()" style="width: 100px">Generate IV</button>
						</div>
					</div>
				</div>
			</div> 


			<div style="margin: 5px;"> 
				<div style="display: flex; flex-direction: column;">
					<div style="display: flex; flex-direction: column;">
						<label>Password:</label>
						<input id="enter_password" style="width: 200px;"></input>
					</div>
					<div style="display: flex; flex-direction: column;">
						<label>Iterations:</label>
						<input id="enter_iterations" style="width: 200px;"></input>
					</div>
					<div style="display: flex; flex-direction: column;">
						<label>Hash:</label>
						<input id="enter_hash" style="width: 200px;" value="SHA-256"></input>
					</div>
					<div style="display: flex;">
						<div style="display: flex; flex-direction: column;">
							<label>Salt:</label>
							<input id="enter_salt" style="width: 200px;"></input>
						</div>
						<div style="display: flex; align-items: flex-end;">
							<button id='gen_salt' onclick="genSalt()" style="width: 100px">Generate Salt</button>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div style="display: flex; flex-direction: column; margin: 5px;">
			<label>Key Data:</label>
			<input id='key_output' style="width: 400px;">
			<button id='get_key' onclick="getKey()" style="width: 100px; margin: 5px;">Get Key</button>
		</div>
<br>
		<div>
			<button id='encrypt_cbc' onclick="encryptCbc()" style="background-color: lightgreen; width: 200px; margin: 5px;">Encrypt AES-256-CBC</button>
		</div>
		<div style="display: flex; flex-direction: column; margin: 5px;">
			<label>Encrypted Output:</label>
			<input id='encrypted_output' style="width: 400px;">
		</div>
		<div style="display: flex; flex-direction: column; margin: 5px;">
			<label>Openssl Output:</label>
			<input id='openssl_output' style="width: 400px;">
		</div>
	</div>

</body>
</html>
<script>

	async function getKey(){
		const key = await getKeyMaterial();	
		const exported = await window.crypto.subtle.exportKey("raw", key);
		const exportedKeyBuffer = new Uint8Array(exported);
		const bits = buf2hex(exportedKeyBuffer);
		document.getElementById("key_output").value = bits;
	}

	function getKeyMaterial() {
		const password = document.getElementById("enter_password").value;
		const enc = new TextEncoder();
		return window.crypto.subtle.importKey(
			"raw",
			enc.encode(password),
			"PBKDF2",
			false,
			["deriveBits", "deriveKey"],
		);
	}

	async function encryptCbc() {
		const plaintext = new TextEncoder().encode(document.getElementById("enter_plaintext").value);
		const salt = hex2buf(document.getElementById("enter_salt").value);
		const iv = hex2buf(document.getElementById("enter_iv").value);
		const iter = Number(document.getElementById("enter_iterations").value);
		const digest_hash = document.getElementById("enter_hash").value;
		const keyMaterial = await getKeyMaterial();

		// Show the derived bits
		const derived_bits = await window.crypto.subtle.deriveBits(
			{
				name: "PBKDF2",
				salt,
				iterations: iter,
				hash: digest_hash,
			},
			keyMaterial,
			256,
		);
		const exportedKeyBuffer = new Uint8Array(derived_bits);
		const bits = buf2hex(exportedKeyBuffer);
		document.getElementById("key_output").value = bits;

		// Set up key for use in aes cbc digest
		const key = await window.crypto.subtle.deriveKey(
			{
				name: "PBKDF2",
				salt,
				iterations: iter,
				hash: digest_hash,
			},
			keyMaterial,
			{ name: "AES-CBC", length: 256 },
			true,
			["encrypt", "decrypt"],
		);
		const encrypted_result = await window.crypto.subtle.encrypt({ name: "AES-CBC", iv }, key, plaintext);
		const result = buf2hex(encrypted_result); 
		document.getElementById("encrypted_output").value = result;
		document.getElementById("openssl_output").value = "Salted__" + result;
	}

	function genIv(){
		var iv = crypto.getRandomValues(new Uint8Array(16));
		document.getElementById("enter_iv").value = buf2hex(iv).toUpperCase();	
	}

	function genSalt(){
		var salt = crypto.getRandomValues(new Uint8Array(8));
		document.getElementById("enter_salt").value = buf2hex(salt).toUpperCase();	
	}

	function buf2hex(buffer) { // buffer is an ArrayBuffer
		return [...new Uint8Array(buffer)]
			.map(x => x.toString(16).padStart(2, '0'))
			.join('');
	}
	 // This function converts a hex string into an ArrayBuffer for hash processing.
	function hex2buf(hexString){
		// convert to a number array representing the hex bytes.
		const hexBytesArray = new Array;
		for(var i=0; i < hexString.length; i+=2){
			hexBytesArray.push(parseInt(hexString.substring(i, i+2), 16));
		}
		const hexArrayBuffer = new Uint8Array(hexBytesArray);
		return hexArrayBuffer;
	}


	function encode64(){
		let raw_text = document.getElementById("raw_64encode_text").value;
		console.log("Encoding the string: '" + raw_text + "'");
		const encoded64 = btoa(raw_text);
		console.log("Encoded string: '" + encoded64 + "'");
		document.getElementById("encoded64_text").value = encoded64;
		document.getElementById("raw_64encoded_text").value = encoded64;
	}

	function decode64(){
		let decoded_text = document.getElementById("raw_64encoded_text").value;
		console.log("Decoding the string: '" + decoded_text + "'");
		const decoded64 = atob(decoded_text);
		console.log("Decoded string: '" + decoded64 + "'");
		document.getElementById("decoded64_text").value = decoded64;
	}

</script>






